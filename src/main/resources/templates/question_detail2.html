<html layout:decorate="~{layout}">
  <div class="container my-3" layout:fragment="content">

    <div class="container my-4">
      <!-- 질문 카드 (예약정보 확인글) -->
      <div class="card border-0 shadow-sm rounded-3 mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <span class="badge rounded-pill border text-secondary small me-2">예약정보</span>
              <h2 class="h5 d-inline" th:text="${question.subject}">제목</h2>

              <!-- 예약일시 강조 -->
              <div class="mt-2">
                <span th:if="${question.modifyDate != null}"
                      class="badge bg-info text-dark fw-semibold">
                  예약일시: <span th:text="${#temporals.format(question.modifyDate.plusHours(9), 'yyyy-MM-dd HH:mm')}">2025-01-01 10:00</span>
                </span>
                <!-- 만약 question.date 필드명이 다르면 서버쪽 필드명에 맞춰 수정하세요 -->
              </div>
            </div>
            <a th:id="|question_${question.id}|"></a>
          </div>

          <div class="mt-3 card-text" style="white-space: pre-line;" th:text="${question.content}">콘텐츠</div>

          <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="small text-muted">
              <div th:if="${question.author != null}" th:text="${question.author.username}">글쓴이</div>
              <div th:text="${#temporals.format(question.createdate, 'yyyy-MM-dd HH:mm')}">작성일</div>
            </div>

            <div class="d-flex gap-2 align-items-center">
              <!-- 수정 (작성자만) -->
              <a th:href="@{|/question/modify/${question.id}?type=${question.boardType}|}"
                 class="btn btn-sm btn-outline-secondary d-flex align-items-center"
                 sec:authorize="isAuthenticated()"
                 th:if="${question.author != null and question.author.username == #authentication.getPrincipal().getUsername()}"
                 aria-label="수정">
                <i class="bi bi-pencil"></i>
                <span class="ms-1">수정</span>
              </a>

              <!-- 삭제 (작성자만) -->
              <a href="javascript:void(0);"
                 th:data-uri="@{|/question/delete/${question.id}|}"
                 class="delete btn btn-sm btn-outline-danger d-flex align-items-center"
                 sec:authorize="isAuthenticated()"
                 th:if="${question.author != null and question.author.username == #authentication.getPrincipal().getUsername()}"
                 aria-label="삭제">
                <i class="bi bi-trash"></i>
                <span class="ms-1">삭제</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- 답변(관리자 전용 안내 및 리스트) -->
      <h5 class="mt-4 mb-3">
        <span th:text="|${#lists.size(question.answerList)}개의 답변이 있습니다|">답변 갯수</span>
      </h5>

      <!-- 답변 반복: 표시만, 추천/비추천 제거 -->
      <div th:each="answer : ${question.answerList}">
        <div class="card border-0 shadow-sm rounded-3 mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <span class="badge rounded-pill border text-primary small me-2">답변</span>
              </div>
              <div class="small text-muted text-end">
                <div th:if="${answer.author != null}" th:text="${answer.author.username}">작성자</div>
                <div th:text="${#temporals.format(answer.createdate, 'yyyy-MM-dd HH:mm')}">작성시간</div>
              </div>
            </div>

            <div class="mt-3 card-text" style="white-space: pre-line;" th:text="${answer.content}">답변 내용</div>

            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="d-flex gap-2">
                <!-- 답변의 수정/삭제 버튼은 기존 권한 체크대로 유지 (작성자만) -->
                <a th:href="@{|/answer/modify/${answer.id}|}"
                   class="btn btn-sm btn-outline-secondary d-flex align-items-center"
                   sec:authorize="isAuthenticated()"
                   th:if="${answer.author != null and answer.author.username == #authentication.getPrincipal().getUsername()}"
                   aria-label="답변 수정">
                  <i class="bi bi-pencil"></i>
                  <span class="ms-1">수정</span>
                </a>

                <a href="javascript:void(0);"
                   th:data-uri="@{|/answer/delete/${answer.id}|}"
                   class="delete btn btn-sm btn-outline-danger d-flex align-items-center"
                   sec:authorize="isAuthenticated()"
                   th:if="${answer.author != null and answer.author.username == #authentication.getPrincipal().getUsername()}"
                   aria-label="답변 삭제">
                  <i class="bi bi-trash"></i>
                  <span class="ms-1">삭제</span>
                </a>
              </div>

              <div th:if="${answer.modifyDate != null}" class="small text-muted">modified: <span th:text="${#temporals.format(answer.modifyDate, 'yyyy-MM-dd HH:mm')}"></span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 답글 작성 영역: 관리자만 작성 가능 -->
      <div class="my-4">
        <div sec:authorize="hasRole('ROLE_ADMIN')">
          <!-- 관리자는 답글 작성 가능: 기존 서브미션 폼을 유지 -->
          <form th:action="@{|/answer/create/${question.id}|}"
                th:object="${answerForm}"
                method="post"
                class="p-3 bg-light rounded-3"
                onsubmit="return validateNotBlank(this);">
            <div th:replace="~{form_errors :: formErrorsFragment}"></div>

            <textarea th:field="*{content}"
                      class="form-control mb-2"
                      rows="5"
                      placeholder="답글 내용을 입력하세요."
                      required
                      pattern=".*\\S.*"
                      title="공백만 입력할 수 없습니다."></textarea>

            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-primary d-flex align-items-center" aria-label="답글 등록">
                <i class="bi bi-check2-circle"></i><span class="ms-2">답글등록</span>
              </button>
            </div>
          </form>
        </div>

        <div sec:authorize="!hasRole('ROLE_ADMIN')" class="alert alert-secondary py-2">
          <small class="mb-0">답글은 관리자만 작성할 수 있습니다.</small>
        </div>
      </div>

      <!-- 댓글(덧글) 관련 모든 영역 제거 -->

    </div>
  </div>

  <!-- 자바 스크립트: 삭제 핸들러만 남김 -->
  <script layout:fragment="script" type="text/javascript">
    (function() {
      const delete_elements = document.getElementsByClassName("delete");
      Array.from(delete_elements).forEach(function (element) {
        element.addEventListener('click', function () {
          if (confirm("정말로 삭제하시겠습니까?")) {
            location.href = this.dataset.uri;
          }
        });
      });
    })();
  </script>
</html>
